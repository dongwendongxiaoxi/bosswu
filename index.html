<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS PWA è®¾ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç‰›é©¬çš„ä¸€å¤©">
    
    <!-- å®‰å“ PWA è®¾ç½® -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3a8a">
    
    <!-- ğŸ‘’ å›¾æ ‡è®¾ç½®ï¼šç›´æ¥é“¾æ¥åˆ°åŒç›®å½•ä¸‹çš„ icon.png -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <title>ç‰›é©¬çš„ä¸€å¤©</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>

    <style>
        /* æµ·è´¼ç‹ä¸»é¢˜å­—ä½“ä¸èƒŒæ™¯ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
            background-color: #FFFDF5; /* ç¾Šçš®çº¸è‰² */
            background-image: radial-gradient(#E8D5B5 1px, transparent 1px);
            background-size: 20px 20px;
            -webkit-tap-highlight-color: transparent; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .calendar-cell { min-height: 85px; border-right: 1px solid #E8D5B5; border-bottom: 1px solid #E8D5B5; }
        .calendar-cell:nth-child(7n) { border-right: none; }
        .event-tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        input, textarea { -webkit-appearance: none; border-radius: 0.5rem; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* å½•éŸ³æ³¢çº¹ - æ·±æµ·è“ */
        .wave-container { display: flex; justify-content: center; align-items: center; height: 40px; gap: 4px; }
        .wave-bar { width: 4px; height: 10px; background-color: #0099CC; border-radius: 2px; animation: wave 1s infinite ease-in-out; }
        .wave-bar:nth-child(1) { animation-delay: 0.0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        @keyframes wave { 0%, 100% { height: 10px; opacity: 0.5; } 50% { height: 25px; opacity: 1; } }

        /* æ¶é­”æœå®çº¹ç†æŒ‰é’® */
        .devil-fruit-btn {
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #d63031);
            box-shadow: 0 4px 15px rgba(214, 48, 49, 0.4), inset 0 0 10px rgba(0,0,0,0.1);
            border: 2px solid #fff;
        }
        .devil-fruit-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800">

    <!-- é¡¶éƒ¨æ  (æ·±æµ·è“é£æ ¼) -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-900 px-4 pt-12 pb-4 flex justify-between items-end shadow-md sticky top-0 z-20 text-white safe-area-top">
        <div class="flex-1">
            <div class="text-xs text-blue-100 font-medium mb-1 opacity-80" id="headerDate">...</div>
            <div class="flex items-center justify-between pr-2">
                <h1 class="text-2xl font-bold tracking-tight flex items-center" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                    <i class="fas fa-skull-crossbones mr-2 text-yellow-400"></i>
                    ç‰›é©¬çš„ä¸€å¤©
                    <span class="text-lg ml-1">ğŸ‘’</span>
                </h1>
                <!-- å¯¼å‡ºæŒ‰é’® (èˆªæµ·å›¾å·è½´é£æ ¼) -->
                <button onclick="showExportMenu()" class="w-10 h-10 rounded-full bg-[#FFF8E1] shadow-lg flex items-center justify-center text-amber-700 active:bg-yellow-100 transition border-2 border-amber-600">
                    <i class="fas fa-scroll text-sm"></i>
                </button>
            </div>
        </div>
        
        <!-- æœˆä»½åˆ‡æ¢ (å¤å¤æœ¨çº¹é£) -->
        <div class="flex bg-[#FFF8E1] rounded-lg p-1 shadow-lg shrink-0 ml-2 border border-amber-200 text-amber-900">
            <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center hover:text-blue-600"><i class="fas fa-chevron-left"></i></button>
            <span class="w-14 flex items-center justify-center font-bold text-sm font-serif" id="currentMonthLabel">...</span>
            <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center hover:text-blue-600"><i class="fas fa-chevron-right"></i></button>
        </div>
    </header>

    <!-- æ˜ŸæœŸå¤´ (æ·±è‰²èƒŒæ™¯) -->
    <div class="grid grid-cols-7 bg-[#3E2723] py-2 shadow-sm border-b border-amber-900">
        <div class="text-center text-xs text-amber-100/70 font-bold">æ—¥</div>
        <div class="text-center text-xs text-amber-100/70 font-bold">ä¸€</div>
        <div class="text-center text-xs text-amber-100/70 font-bold">äºŒ</div>
        <div class="text-center text-xs text-amber-100/70 font-bold">ä¸‰</div>
        <div class="text-center text-xs text-amber-100/70 font-bold">å››</div>
        <div class="text-center text-xs text-amber-100/70 font-bold">äº”</div>
        <div class="text-center text-xs text-amber-100/70 font-bold">å…­</div>
    </div>

    <!-- æ—¥å†ä¸»ä½“ -->
    <div class="flex-1 overflow-y-auto relative" id="calendarContainer">
        <div class="grid grid-cols-7 border-l border-[#E8D5B5]" id="calendarGrid"></div>
        <div class="h-32 flex items-center justify-center opacity-30 pointer-events-none">
            <i class="fas fa-anchor text-6xl text-amber-800"></i>
        </div>
    </div>

    <!-- åº•éƒ¨å½•éŸ³æŒ‰é’® -->
    <div class="fixed bottom-8 left-0 w-full flex flex-col items-center justify-center z-40 safe-area-bottom pointer-events-none">
        <div class="relative group pointer-events-auto">
            <button id="micBtn" class="devil-fruit-btn w-18 h-18 w-[72px] h-[72px] rounded-full text-white flex items-center justify-center text-3xl transition-transform">
                <i class="fas fa-microphone-alt"></i>
            </button>
        </div>
        <p class="text-[10px] text-amber-800 mt-2 font-bold opacity-70 bg-[#FFF8E1]/80 px-2 py-1 rounded-full backdrop-blur-sm">
            ç‚¹å‡»è®°å½•èˆªæµ·æ—¥å¿—
        </p>
    </div>

    <!-- è¯¦æƒ…åˆ—è¡¨å¼¹çª— -->
    <div id="detailModal" class="hidden fixed inset-0 z-[9000] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-[#FFF8E1] w-full max-w-sm rounded-lg p-5 shadow-2xl relative flex flex-col max-h-[60vh] border-4 border-amber-700" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjRkZGOEUxIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNFOEQ1QjUiLz4KPC9zdmc+');">
            
            <!-- å¼¹çª—æ ‡é¢˜ -->
            <div class="flex justify-between items-center mb-4 border-b border-amber-200 pb-2">
                <div>
                    <h3 class="text-xl font-bold text-amber-900 font-serif" id="detailDateTitle">...</h3>
                    <p class="text-xs text-amber-700 font-bold uppercase tracking-wider" id="detailWeekday">...</p>
                </div>
                <button onclick="closeDetailModal()" class="w-8 h-8 rounded-full text-amber-800 hover:bg-amber-200 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- åˆ—è¡¨åŒºåŸŸ -->
            <div id="detailList" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-1"></div>

            <!-- åº•éƒ¨æ“ä½œ -->
            <button onclick="openManualAddFromDetail()" class="w-full py-3 bg-amber-100 text-amber-800 rounded-lg font-bold text-sm hover:bg-amber-200 transition border border-amber-300 border-dashed">
                <i class="fas fa-feather-alt mr-2"></i> æ‰‹å†™ä¸€æ¡æ—¥å¿—
            </button>
        </div>
    </div>

    <!-- å½•éŸ³/ç¼–è¾‘å¼¹çª— -->
    <div id="editModal" class="hidden fixed inset-0 z-[10000] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-[#FFF8E1] w-full max-w-sm rounded-lg p-6 shadow-2xl transition-all relative border-4 border-amber-700">
            
            <div id="listeningOverlay" class="hidden absolute inset-0 bg-[#FFF8E1]/98 z-10 flex-col items-center justify-center rounded-lg">
                <div class="wave-container mb-4">
                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                </div>
                <h3 class="text-lg font-bold text-amber-900 mb-2 font-serif">ç”µè¯è™«æ¥æ”¶ä¸­...</h3>
                <p id="liveText" class="text-sm text-amber-700 px-4 text-center min-h-[20px] font-medium">è¯·ä¸‹è¾¾æŒ‡ä»¤...</p>
                <button onclick="stopMic()" class="mt-6 px-6 py-2 bg-red-100 text-red-700 rounded-full font-bold text-xs border border-red-200">åœæ­¢æ¥æ”¶</button>
            </div>

            <h3 class="text-lg font-bold mb-4 text-center text-amber-900 font-serif flex items-center justify-center">
                <i class="fas fa-compass mr-2 text-amber-600"></i> æ–°çš„èˆªç¨‹
            </h3>
            <textarea id="editContent" rows="3" class="w-full bg-white border-2 border-amber-200 p-3 rounded-lg mb-3 text-base focus:border-amber-500 focus:ring-0 outline-none text-gray-800 placeholder-amber-900/30" placeholder="ä»»åŠ¡å†…å®¹..."></textarea>
            
            <div class="flex gap-2 mb-5">
                <div class="flex-1">
                    <label class="text-xs text-amber-700 font-bold ml-1 mb-1 block">æ—¥æœŸ</label>
                    <input type="date" id="editDate" class="w-full border-2 border-amber-200 p-2.5 rounded-lg bg-white text-sm focus:border-amber-500 outline-none">
                </div>
                <div class="w-28">
                    <label class="text-xs text-amber-700 font-bold ml-1 mb-1 block">æ—¶é—´</label>
                    <input type="time" id="editTime" class="w-full border-2 border-amber-200 p-2.5 rounded-lg bg-white text-sm focus:border-amber-500 outline-none">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-amber-100 text-amber-800 rounded-lg font-bold active:bg-amber-200">å–æ¶ˆ</button>
                <button onclick="saveEvent()" class="flex-1 py-3 bg-red-700 text-white rounded-lg font-bold shadow-md active:scale-95 transition">ç¡®è®¤å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºé€‰é¡¹å¼¹çª— -->
    <div id="exportModal" class="hidden fixed inset-0 z-[11000] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-[#FFF8E1] w-full max-w-sm rounded-lg p-6 shadow-2xl border-4 border-amber-700">
            <h3 class="text-lg font-bold mb-4 text-amber-900 flex items-center border-b border-amber-200 pb-2 font-serif">
                <i class="fas fa-map-marked-alt text-amber-600 mr-2"></i> å¯¼å‡ºèˆªæµ·å›¾
            </h3>
            
            <div class="space-y-3 mb-6">
                <label class="flex items-center p-3 border-2 border-amber-200 rounded-lg bg-white cursor-pointer active:bg-amber-50 transition has-[:checked]:bg-amber-50 has-[:checked]:border-amber-500">
                    <input type="radio" name="exportRange" value="week" class="text-amber-600 focus:ring-amber-500 w-4 h-4">
                    <span class="ml-3 text-sm font-bold text-amber-800">æœ¬å‘¨èˆªç¨‹</span>
                </label>
                <label class="flex items-center p-3 border-2 border-amber-200 rounded-lg bg-white cursor-pointer active:bg-amber-50 transition has-[:checked]:bg-amber-50 has-[:checked]:border-amber-500">
                    <input type="radio" name="exportRange" value="month" checked class="text-amber-600 focus:ring-amber-500 w-4 h-4">
                    <span class="ml-3 text-sm font-bold text-amber-800">æœ¬æœˆèˆªç¨‹</span>
                </label>
                <label class="flex items-center p-3 border-2 border-amber-200 rounded-lg bg-white cursor-pointer active:bg-amber-50 transition has-[:checked]:bg-amber-50 has-[:checked]:border-amber-500">
                    <input type="radio" name="exportRange" value="year" class="text-amber-600 focus:ring-amber-500 w-4 h-4">
                    <span class="ml-3 text-sm font-bold text-amber-800">ä»Šå¹´å…¨çºªå½•</span>
                </label>
                <label class="flex items-center p-3 border-2 border-amber-200 rounded-lg bg-white cursor-pointer active:bg-amber-50 transition has-[:checked]:bg-amber-50 has-[:checked]:border-amber-500">
                    <input type="radio" name="exportRange" value="all" class="text-amber-600 focus:ring-amber-500 w-4 h-4">
                    <span class="ml-3 text-sm font-bold text-amber-800">æ‰€æœ‰å†å²å®è—</span>
                </label>
            </div>

            <div class="flex gap-3">
                <button onclick="closeExportMenu()" class="flex-1 py-3 bg-amber-100 text-amber-800 rounded-lg font-bold active:bg-amber-200">æ”¾å¼ƒ</button>
                <button onclick="runExport()" class="flex-1 py-3 bg-green-700 text-white rounded-lg font-bold shadow-md active:scale-95 transition">
                    <i class="fas fa-file-csv mr-1"></i> ç”ŸæˆCSV
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. å…¨å±€åˆå§‹åŒ– ---
        dayjs.locale('zh-cn');
        
        var state = {
            currentDate: dayjs(),
            selectedDateStr: null, 
            events: JSON.parse(localStorage.getItem('xi_assistant_events')) || [],
            isRecording: false
        };
        
        var recognition = null;
        var SpeechClass = window.SpeechRecognition || window.webkitSpeechRecognition;

        window.onload = function() {
            renderHeader();
            renderCalendar();
            document.getElementById('micBtn').addEventListener('click', startRecordingFlow);
        };

        // --- 2. å¯¼å‡ºåŠŸèƒ½ ---
        function showExportMenu() {
            var el = document.getElementById('exportModal');
            if(el) el.classList.remove('hidden');
            else alert("å¯¼å‡ºæ¨¡å—åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢");
        }

        function closeExportMenu() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function runExport() {
            try {
                var rangeInput = document.querySelector('input[name="exportRange"]:checked');
                if(!rangeInput) return;
                
                var range = rangeInput.value;
                var filtered = [];
                var now = dayjs();
                
                var sortedEvents = [].concat(state.events).sort(function(a, b) {
                    return (a.date + a.time).localeCompare(b.date + b.time);
                });

                if (range === 'all') {
                    filtered = sortedEvents;
                } else if (range === 'month') {
                    filtered = sortedEvents.filter(function(e) {
                        return dayjs(e.date).isSame(state.currentDate, 'month');
                    });
                } else if (range === 'year') {
                    filtered = sortedEvents.filter(function(e) {
                        return dayjs(e.date).isSame(now, 'year');
                    });
                } else if (range === 'week') {
                    filtered = sortedEvents.filter(function(e) {
                        return dayjs(e.date).isSame(now, 'week');
                    });
                }

                if (filtered.length === 0) {
                    alert("è¯¥èˆªè·¯æ²¡æœ‰è®°å½•");
                    return;
                }

                var csvContent = "æ—¥æœŸ,æ—¶é—´,ä»»åŠ¡å†…å®¹\n";
                filtered.forEach(function(e) {
                    var safeContent = (e.content || "").replace(/"/g, '""').replace(/\n/g, " ");
                    csvContent += e.date + "," + e.time + ",\"" + safeContent + "\"\n";
                });

                var blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.setAttribute("href", url);
                
                var filename = "ç‰›é©¬çš„èˆªæµ·æ—¥å¿—_" + dayjs().format('YYYYMMDD') + ".csv";
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                closeExportMenu();

            } catch(e) {
                alert("å¯¼å‡ºå¤±è´¥ï¼š" + e.message);
                console.error(e);
            }
        }

        // --- 3. å½•éŸ³æµç¨‹ ---
        function startRecordingFlow() {
            if(!SpeechClass) return alert("æ‚¨çš„èˆ¹åªä¸æ”¯æŒè¯­éŸ³è®¾å¤‡ï¼Œè¯·æ‰‹åŠ¨è®°å½•");

            document.getElementById('editContent').value = '';
            document.getElementById('editDate').value = dayjs().format('YYYY-MM-DD');
            document.getElementById('editTime').value = dayjs().format('HH:mm');

            var modal = document.getElementById('editModal');
            var overlay = document.getElementById('listeningOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            document.getElementById('liveText').innerText = "ç­‰å¾…æŒ‡ä»¤...";
            
            if(recognition) {
                try { recognition.abort(); } catch(e){}
                recognition = null;
            }

            try {
                recognition = new SpeechClass();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = true;

                recognition.onstart = function() {
                    state.isRecording = true;
                    document.getElementById('liveText').innerText = "æ­£åœ¨æ¥æ”¶...";
                };

                recognition.onresult = function(event) {
                    var text = event.results[0][0].transcript;
                    document.getElementById('liveText').innerText = text;
                    if(event.results[0].isFinal) {
                        finishRecording(text);
                    }
                };

                recognition.onerror = function(e) {
                    if(e.error !== 'no-speech') {
                        stopMic(); 
                    }
                };

                recognition.onend = function() {
                    if(state.isRecording) stopMic();
                };

                recognition.start();

            } catch(e) {
                alert("è®¾å¤‡æ•…éšœ: " + e.message);
                stopMic();
            }
        }

        function stopMic() {
            state.isRecording = false;
            if(recognition) {
                try { recognition.stop(); } catch(e){}
            }
            var overlay = document.getElementById('listeningOverlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        function finishRecording(text) {
            stopMic();
            processVoice(text);
        }

        // --- 4. è¯¦æƒ…é¡µ & åˆ é™¤ ---
        function openDetailModal(dateStr) {
            state.selectedDateStr = dateStr;
            var dateObj = dayjs(dateStr);
            
            document.getElementById('detailDateTitle').innerText = dateObj.format('MæœˆDæ—¥');
            document.getElementById('detailWeekday').innerText = dateObj.format('dddd');
            
            var listEl = document.getElementById('detailList');
            listEl.innerHTML = '';

            var dayEvents = state.events.filter(e => e.date === dateStr);
            
            if(dayEvents.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-8 text-amber-800/50">
                        <i class="fas fa-skull text-4xl mb-2 opacity-30"></i>
                        <p class="text-xs font-bold">æš‚æ— å†’é™©è®¡åˆ’</p>
                    </div>
                `;
            } else {
                dayEvents.forEach(e => {
                    var div = document.createElement('div');
                    div.className = "flex items-start p-3 bg-white/60 rounded-lg border border-amber-200 group";
                    div.innerHTML = `
                        <div class="w-12 text-xs font-bold text-amber-700 pt-0.5 font-mono">${e.time || '--:--'}</div>
                        <div class="flex-1 text-sm font-medium text-amber-900 break-all leading-snug">${e.content}</div>
                        <button onclick="deleteEvent('${e.id}')" class="text-amber-400 hover:text-red-500 pl-3 active:scale-95 transition">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    listEl.appendChild(div);
                });
            }

            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function openManualAddFromDetail() {
            closeDetailModal();
            openEditModal(state.selectedDateStr, '', dayjs().format('HH:mm'));
        }

        function deleteEvent(id) {
            if(confirm("è¦ä¸¢å¼ƒè¿™æ¡èˆªæµ·è®°å½•å—ï¼Ÿ")) {
                state.events = state.events.filter(e => e.id !== id);
                localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
                renderCalendar();
                openDetailModal(state.selectedDateStr);
            }
        }

        // --- 5. è¾…åŠ©é€»è¾‘ ---
        function processVoice(text) {
            var date = dayjs();
            var content = text;
            var dateChanged = false;

            if(text.includes('æ˜å¤©')) { date = date.add(1, 'day'); content = content.replace(/æ˜å¤©/g, ''); dateChanged = true; }
            else if(text.includes('åå¤©')) { date = date.add(2, 'day'); content = content.replace(/åå¤©/g, ''); dateChanged = true; }
            
            var weekMap = { 'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'æ—¥': 0, 'å¤©': 0 };
            var weekMatch = content.match(/(ä¸‹|æœ¬)?(?:ä¸ª)?(?:å‘¨|æ˜ŸæœŸ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/);

            if (weekMatch && !dateChanged) {
                var prefix = weekMatch[1]; 
                var dayChar = weekMatch[2];
                var targetDay = weekMap[dayChar];

                if (prefix === 'ä¸‹') {
                    date = date.add(1, 'week').day(targetDay);
                } else {
                    var tempDate = dayjs().day(targetDay);
                    if (tempDate.isBefore(dayjs(), 'day')) {
                        date = tempDate.add(1, 'week');
                    } else {
                        date = tempDate;
                    }
                }
                content = content.replace(weekMatch[0], '');
                dateChanged = true;
            }

            var dateMatch = content.match(/(\d{1,2})æœˆ(\d{1,2})[å·æ—¥]?/);
            if (dateMatch) {
                var month = parseInt(dateMatch[1]) - 1;
                var day = parseInt(dateMatch[2]);
                date = date.month(month).date(day);
                if (date.isBefore(dayjs(), 'day')) date = date.add(1, 'year');
                content = content.replace(dateMatch[0], '');
            }
            
            var targetTime = dayjs().format('HH:mm');
            var timeMatch = content.match(/(ä¸Šåˆ|ä¸‹åˆ|æ™šä¸Š)?(\d{1,2})ç‚¹(\d{1,2})?/);
            if(timeMatch) {
                var h = parseInt(timeMatch[2]);
                if((timeMatch[1] === 'ä¸‹åˆ' || timeMatch[1] === 'æ™šä¸Š') && h < 12) h += 12;
                var m = timeMatch[3] ? parseInt(timeMatch[3]) : 0;
                targetTime = (h<10?'0'+h:h) + ':' + (m<10?'0'+m:m);
                content = content.replace(timeMatch[0], '').replace('åˆ†','');
            }
            
            document.getElementById('editDate').value = date.format('YYYY-MM-DD');
            document.getElementById('editContent').value = content.trim();
            document.getElementById('editTime').value = targetTime;
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            stopMic();
        }

        function openEditModal(date, content, time) {
            var modal = document.getElementById('editModal');
            var overlay = document.getElementById('listeningOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.add('hidden'); 
            overlay.classList.remove('flex');
            
            document.getElementById('editDate').value = date || dayjs().format('YYYY-MM-DD');
            document.getElementById('editContent').value = content || '';
            document.getElementById('editTime').value = time || dayjs().format('HH:mm');
        }

        function renderHeader() {
            document.getElementById('headerDate').innerText = dayjs().format('YYYYå¹´MæœˆDæ—¥ dddd');
            document.getElementById('currentMonthLabel').innerText = state.currentDate.format('Mæœˆ');
        }

        function renderCalendar() {
            var grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            var start = state.currentDate.startOf('month');
            var days = state.currentDate.daysInMonth();
            var offset = start.day();

            for(var i=0; i<offset; i++) grid.innerHTML += '<div class="calendar-cell bg-[#FFF8E1]"></div>';

            for(var i=1; i<=days; i++) {
                var dateStr = state.currentDate.date(i).format('YYYY-MM-DD');
                var isToday = dateStr === dayjs().format('YYYY-MM-DD');
                var dayEvents = state.events.filter(e => e.date === dateStr);
                
                var cell = document.createElement('div');
                cell.className = 'calendar-cell p-1 relative ' + (isToday ? 'bg-yellow-200' : 'bg-transparent');
                
                // æ—¥æœŸæ•°å­—
                var dayNumClass = isToday ? 'text-blue-800' : 'text-amber-900';
                cell.innerHTML = '<div class="text-right text-xs font-bold mb-1 '+dayNumClass+'">'+i+'</div>';
                
                dayEvents.forEach(e => {
                    // ä¸»é¢˜é¢œè‰²åˆ†ç±»
                    var color = "bg-blue-600 text-white"; // é»˜è®¤å±±æ²»è“
                    if(e.content.includes("é£ç”µ")) color = "bg-orange-500 text-white"; // å¨œç¾æ©˜
                    if(e.content.includes("å‚¨èƒ½")) color = "bg-green-600 text-white"; // ç´¢éš†ç»¿
                    if(e.content.includes("ä¼šè®®")) color = "bg-red-600 text-white"; // è·¯é£çº¢
                    
                    cell.innerHTML += '<div class="event-tag '+color+' shadow-sm">'+e.content+'</div>';
                });

                (function(d){ cell.onclick = function(){ openDetailModal(d); }; })(dateStr);
                
                grid.appendChild(cell);
            }
        }

        function changeMonth(n) {
            state.currentDate = state.currentDate.add(n, 'month');
            renderHeader();
            renderCalendar();
        }

        function saveEvent() {
            var content = document.getElementById('editContent').value;
            var date = document.getElementById('editDate').value;
            var time = document.getElementById('editTime').value;
            
            if(!content) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");
            
            state.events.push({ id: Date.now().toString(), content: content, date: date, time: time });
            localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
            
            closeEditModal();
            renderCalendar();
            
            if(state.selectedDateStr === date) {
                openDetailModal(date);
            }
        }
    </script>
</body>
</html>